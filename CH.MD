# Babu-Bus
与 Babu 总线相关的工具和文档

## 简介
babu-bus 是一种专有协议，基于通过 RS485 总线的 UART 进行通信<br>
UART 的时钟频率为 1228800bps，具有 1 个偶校验位和 1 个停止位。

## 报头和设备寻址
babu 总线使用两种数据包格式：<br>
长报头数据包，其中包含指示多个可用设备之间主从关系的数据<br>
短报头数据包，用于在 1 个预设的主从设备之间进行通信。

这些数据包通常由一个起始字节 _3D_、一个数据包长度指示符和一个用于验证报头完整性的 8 位 CRC 组成。<br>

### 长报头

| 字节数 | 内容 | 占用字节数 |
|-------------|----------------------------------|----------------|
| 0 | 0x3D | 1 |
| 1 | 标志（小于 0x80）| 1 |
| 2~3 | 数据包序列 | 2 |
| 4~5 | 数据包总长度 L | 2 |
| 6 | 对所有先前字节进行 CRC8 校验 [1] | 1 |
| 7~8 | 目标地址 | 2 |
| 9~10 | 源地址 | 2 |
| 11~(L-3) | 数据包内容 | L-13 |
| (L-2)~(L-1) | 对所有先前字节进行 CRC16 校验 [2] | 2 |

[1] CRC8 生成多项式：0x39，初始值 0x66，无异或和逆运算。
[2] CRC16 生成多项式：0x1021，初始值 0x913D，无异或和逆运算，但数组中低字节优先。

### 寻址关系

|地址编号 | 含义 |
|----------------|------------------------------------------------------------------------------|
| 地址编号 | 含义 |
| 0x03 | MC（运动控制器）|
| 0x06 | AP（第一种上位机，X系列适用）|
| 0x07 | AMS |
| 0x08 | TH |
| 0x09 | AP2（第二种上位机，P系列和A系列适用）|
| 0x0E | AHB |
| 0x0F | EXT（可能是外接控制板）|
| 0x12 | AMS lite |
| 0x13 | CTC |

### 短格式头

| 字节数 | 内容 | 占用字节数 |
|-------------|--------------------------------------|----------------|
| 0 | 0x3D | 1 |
| 1 |标志和序列（大于 0x80）| 1 |
| 2 | 数据包总长度 L | 1 |
| 3 | 所有前一个字节的 CRC8 校验 [1] | 1 |
| 4 | 数据包类型 | 1 |
| 5~(L-3) | 数据包内容 | L-7 |
| (L-2)~(L-1) | 所有前一个字节的 CRC16 校验 [2] | 2 |

[1] CRC8 生成多项式：0x39，初始值 0x66，无异或和逆运算。<br>
[2] CRC16 生成多项式：0x1021，初始值 0x913D，无异或和逆运算，但数组中低字节优先。<br>

短帧头的数据类型（在 AMS Lite 中收集，因此列出的内容适用于 AMS Lite）：
| 值 | （可能的）含义 |
|-------|-----------------------------------------------|
| 0x03 | 读取耗材运动信息 |
| 0x04 | 读取并更改 AMS 灯的运动状态 |
| 0x05 | 验证设备是否在线 |
| 0x06 | 未知 |
| 0x07 | 读取 NFC 信息 |
| 0x20 | 打印机心跳包 |

# 工具
## 解析器
- Protoparser.py -> 数据包解析器，最适合 X1 系列数据包
## 模拟器
- AMCU -> 由研究员 40 61 N 编写的 AMS 模拟器

## 研究团队：
- 40 61 N
- leo nll rmc
